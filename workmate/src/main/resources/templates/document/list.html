<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/document_layout}"
	layout:fragment="content">
<head>
<meta charset="UTF-8">
<title></title>
<style>
	.card{
		padding: 100px;
	}
	#newTagInput {
    border: 1px solid #ced4da !important; /* Bootstrap ê¸°ë³¸ border */
    border-radius: 0.375rem; /* Bootstrap ê¸°ë³¸ border-radius */
    padding: 0.375rem 0.75rem;
    margin-top: 30px;
  }
</style>
</head>
<body>
	<div class="row">
		<div class="col-md-12">
			<div class="card">
				<div class="card-header">
					<div class="d-flex align-items-center">
						<h4 class="card-title">ì „ì‚¬ ìë£Œì‹¤</h4>
						<th:block th:if="${userId != null and teamNo == 'ROLE_T001'}">
						    <button class="btn btn-primary btn-round ms-auto" onclick="uploadModal()"
						            data-bs-toggle="modal" data-bs-target="#addRowModal">
						        <i class="fa fa-plus"></i> FILE UPLOAD
						    </button>
						</th:block>
					</div>
				</div>
				<div class="card-body">
				<!-- File Upload Modal -->
				<div class="modal fade" id="addRowModal" tabindex="-1" role="dialog" aria-hidden="true" >
				    <div class="modal-dialog" role="document">
				        <div class="modal-content">
				            <div class="modal-header border-0">
				                <h3 class="modal-title">íŒŒì¼ ì—…ë¡œë“œ</h3>
				                <button type="button" class="close" onclick="closeModal()">
				                    <span aria-hidden="true">Ã—</span>
				                </button>
				            </div>
				            <div class="modal-body">
				                <p class="small">íŒŒì¼ì„ ì—…ë¡œë“œ í•´ì£¼ì„¸ìš”.</p>
				                <form id="uploadForm" method="post" enctype="multipart/form-data"  name="uploadForm" action="/archive/upload">
				                    <div class="row">
				                        <div class="col-sm-12">
				                            <div class="form-group form-group-default">				                           
				                                <label>íŒŒì¼ì„¤ëª…</label>
				                                <input id="addName" name="fileDesc" type="text" class="form-control" placeholder="íŒŒì¼ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
				                            </div>
				                             <div class="form-group form-group-default">
				                                <label>íŒŒì¼ë¶„ë¥˜</label>
												
												<select id="fileTagSelect" name="fileTag" class="form-select input-fixed">
												    <option value="">-- ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
												    <th:block th:each="tag : ${#sets.toSet(lists.![fileTag])}">
												        <option th:value="${tag}" th:text="${tag}"></option>
												    </th:block>
												</select>
												  <input type="text" id="newTagInput" class="form-control mt-2" placeholder="ìƒˆë¡œìš´ ë¶„ë¥˜ ì…ë ¥" />
												  <button type="button" onclick="addNewTag()" class="btn btn-primary btn-sm"><i class="fa fa-plus"></i> ADD</button>
				                            </div>
				                        </div>
				                        <input type="file" name="uploadFile" class="form-control-file" id="uploadFile">
				                    </div>
				                    <div class="modal-footer border-0">
				            	<button type="button" id="addRowButton" class="btn btn-primary" >ì—…ë¡œë“œí•˜ê¸°</button>
				                <button type="button" class="btn btn-danger" onclick="closeModal()">ì·¨ì†Œ</button>
				            		</div>
				                </form>
				            </div>				            
				        </div>
				    </div>
				</div>
				<!-- íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
					<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
					  <div class="modal-dialog modal-xl modal-dialog-centered">
					    <div class="modal-content">
					      <div class="modal-header">
					        <h6 class="modal-title"><b>íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°</b></h6>
					        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					      </div>
					      <div class="modal-body text-center">
					        <iframe id="previewFrame" style="width:100%; height:80vh;" frameborder="0"></iframe>
					      </div>
					    </div>
					  </div>
					</div>

					<div class="table-responsive">
							<table id="documentTable" class="table">
								<thead>
								    <tr>								    	
								        <th>
								        	<select id="extFilter" class="form-select">
								                <option value="">ğŸ”ï¸ ìë£Œ ì „ì²´</option>
								            </select>
								        </th>
								        <th>íŒŒì¼ëª…</th>
								        <th>íŒŒì¼ì„¤ëª…</th>
								        <th>íŒŒì¼í¬ê¸°</th>
								        <th>í™•ì¥ì</th>
								        <th>ì—…ë¡œë“œë‚ ì§œ</th>	
								        <th:block th:if="${userId != null and teamNo == 'ROLE_T001'}">
								        <th>ì—…ë¡œë“œì‚¬ì›</th>
   										</th:block>	
   										<th>ë¯¸ë¦¬ë³´ê¸°</th>									        
								        <th><i class="fas fa-download"></i></th>
								        <th:block th:if="${userId != null and teamNo == 'ROLE_T001'}">
								        <th> <i class="fas fa-trash-alt"></i></th>
   										</th:block>
								    </tr>
								</thead>
								<tbody>
									<!-- ë‹¨ê±´ : ë°°ì—´ -->
									<tr th:each="item : ${lists}">
										<td>[[ ${item.fileTag} ]]</td>
										<td>[[ ${item.fileName} ]]</td>
										<td>[[ ${item.fileDesc} ]]</td>
										<td>[[ ${item.formattedSize} ]]</td>
										<td>[[ ${item.extenstion} ]]</td>
										<td>[[ ${#dates.format(item.fileRegDate, 'yyyy-MM-dd')} ]]</td>
										<th:block th:if="${userId != null and teamNo == 'ROLE_T001'}">
										<td>[[ ${item.userId} ]]</td>
										</th:block>
										<td>
										  <button class="btn btn-outline-secondary btn-sm me-2"
										          th:data-file-url="@{/document/preview/{documentNo}(documentNo=${item.documentNo})}"
										          onclick="previewFile(this)">
										    <i class="fas fa-eye"></i> ë¯¸ë¦¬ë³´ê¸°
										  </button>										  
										</td>								
										<td><a th:href="@{/document/download/{documentNo}(documentNo=${item.documentNo})}">
										    <i class="fas fa-download"></i>
											</a>
										</td>
										<th:block th:if="${userId != null and teamNo == 'ROLE_T001'}">
										<td>
										    <i class="fas fa-trash-alt"
										       th:if="${item != null and not #strings.isEmpty(item.fileName)}"
										       th:data-document-no="${item.documentNo}"
										       onclick="deleteDocument(this)">										       
										    </i>
										</td>
										</th:block>										
									</tr>
								</tbody>
							</table>
						</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script>
// íŒŒì¼ ë“±ë¡ ëª¨ë‹¬
function uploadModal() {
    var modal = new bootstrap.Modal(document.getElementById('addRowModal'));
    modal.show();
}

function closeModal() {
    var modalElement = document.getElementById('addRowModal');
    var modalInstance = bootstrap.Modal.getInstance(modalElement);
    
    if (modalInstance) {
        modalInstance.hide();
    }

    // backdrop ê°•ì œ ì œê±°
    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
}

// íŒŒì¼ ì—…ë¡œë“œ
document.getElementById("addRowButton").addEventListener("click", function () {
    const fileInput = document.getElementById("uploadFile");
    const file = fileInput.files[0];

    if (!file) {
        alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
    }

    const formData = new FormData(document.uploadForm);

    fetch("/workmate/document/upload", {
        method: "POST",
        body: formData
    }) .then(response => response.text() 
    ) .then(response => {
            if (response) {
                alert("ì—…ë¡œë“œ ì™„ë£Œ");
            location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            } 
        })
        .catch(error => {
            console.error("ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
            alert("ì—…ë¡œë“œ ì‹¤íŒ¨");
        });
});

// íŒŒì¼ ë‹¨ê±´ ì‚­ì œ
function deleteDocument(icon) {
    const documentNo = icon.getAttribute("data-document-no");

    if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        fetch(`/workmate/document/delete/${documentNo}`, {
            method: "DELETE"
        })
        .then(response => {
            if (response.ok) {
                alert("ì‚­ì œ ì™„ë£Œ");
                location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            } else {
                alert("ì‚­ì œ ì‹¤íŒ¨");
            }
        })
        .catch(error => {
            console.error("ì‚­ì œ ì˜¤ë¥˜:", error);
            alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }
}
// datatable ì„¤ì •
$(document).ready(function() {
    var table = $('#documentTable').DataTable({
        "paging": true,
        "ordering": false,
        "searching": true,
        "info": false,
        "lengthMenu": [10, 25, 50, 100],
        initComplete: function () {
            var column = this.api().column(0);  // íŒŒì¼ë¶„ë¥˜
            var select = $('#extFilter'); // theadì— ìˆëŠ” select ê°€ì ¸ì˜¤ê¸°

            // ê¸°ì¡´ ì˜µì…˜ ì œê±° í›„ ìƒˆë¡œìš´ ì˜µì…˜ ì¶”ê°€
            column.data().unique().sort().each(function (d, j) {
                select.append('<option value="' + d + '">' + d + '</option>');
            });

            // í•„í„° ì ìš© ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            select.on('change', function () {
                var val = $.fn.dataTable.util.escapeRegex($(this).val());
                column.search(val ? '^' + val + '$' : '', true, false).draw();
            });
        }
    });
});
// ìƒˆë¡œìš´ íŒŒì¼ ë¶„ë¥˜ ì¶”ê°€
function addNewTag() {
    const input = document.getElementById('newTagInput');
    const select = document.getElementById('fileTagSelect');
    const newValue = input.value.trim();

    if (!newValue) {
      alert("ì¶”ê°€í•  íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    // ì¤‘ë³µ ì²´í¬
    const exists = Array.from(select.options).some(option => option.value === newValue);
    if (exists) {
      alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íƒœê·¸ì…ë‹ˆë‹¤.");
      return;
    }

    // ìƒˆë¡œìš´ ì˜µì…˜ ì¶”ê°€
    const newOption = new Option(newValue, newValue);
    select.add(newOption);
    select.value = newValue; // ë°©ê¸ˆ ì¶”ê°€í•œ ê°’ ì„ íƒë˜ê²Œ

    input.value = ""; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
  }
  // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
  function previewFile(button) {
    const fileUrl = button.getAttribute("data-file-url");
    const iframe = document.getElementById("previewFrame");
    iframe.src = fileUrl;

    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}
</script>
</html>