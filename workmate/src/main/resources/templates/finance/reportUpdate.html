<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/finance_layout}" layout:fragment="content">

<head>
	<meta charset="UTF-8" />
	<title>ë¦¬í¬íŠ¸ ìˆ˜ì •</title>
	<style>
	  .form-box {
			background-color: white; /* âœ… ì—¬ê¸°ë§Œ í°ìƒ‰ */
			padding: 30px;
			border-radius: 12px;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
			margin-top: 50px;
			}
		#container {
			max-width: 1000px;
			margin: 0 auto;
			padding: 40px;
		}

		input[type="date"] {
			width: 130px;
			/* âœ… ë„ˆë¹„ ì¤„ì´ê¸° */
			padding: 6px;
			font-size: 14px;
			box-sizing: border-box;
		}

		h2,
		h3 {
			color: #333;
			margin-top: 30px;
			margin-bottom: 10px;
		}

		input[type="text"],
		input[type="number"],
		input[type="date"],
		select {
			width: 100%;
			padding: 8px;
			box-sizing: border-box;
			font-size: 14px;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 10px;
		}

		th,
		td {
			border: 1px solid #ccc;
			padding: 10px;
			text-align: center;
			vertical-align: middle;
			font-size: 14px;
		}

		th {
			background-color: #f2f2f2;
			font-weight: bold;
		}

		.btn-group {
			margin: 15px 0;
			text-align: right;
		}

		.btn {
			padding: 8px 16px;
			margin-left: 5px;
			border: none;
			border-radius: 4px;
			font-size: 14px;
			cursor: pointer;
		}

		.plus {
			background-color: #28a745;
			color: white;
		}

		.minus {
			background-color: #dc3545;
			color: white;
		}

		.report-section {
			margin-top: 40px;
		}

		.attachment-area textarea {
			width: 100%;
			padding: 12px;
			border: 1px solid #ccc;
			border-radius: 4px;
			resize: vertical;
			font-size: 14px;
		}

		.file-upload>div {
			display: flex;
			align-items: center;
			margin-top: 10px;
		}

		.file-upload input[type="file"] {
			flex: 1;
			margin-right: 10px;
		}

		.button-area {
			display: flex;
			justify-content: flex-end;
			gap: 10px;
			margin-top: 30px;
		}

		.btn-approve {
			background-color: #17a2b8;
			color: #fff;
		}

		.btn-submit {
			background-color: #007bff;
			color: #fff;
		}

		.btn-approve:hover {
			background-color: #138496;
		}

		.btn-submit:hover {
			background-color: #0056b3;
		}
	</style>
</head>

<body>
	<div id="container">
		<div class="form-box">
		<input type="text" name="reportTitle" th:value="${report[0].reportTitle}" id="reportTitle">
		<h3>ê¸°ë³¸ ì •ë³´</h3>
		<table>
			<tr>
				<th>ê¸°ê°„</th>
				<td>
					<div style="display: flex; gap: 10px; align-items: center;">
						<input type="date" style="width: 130px;" id="startDate" th:value="${#dates.format(report[0].transStart, 'yyyy-MM-dd')}"/>
						~
						<input type="date" style="width: 130px;" id="endDate" th:value="${#dates.format(report[0].transEnd, 'yyyy-MM-dd')}" />
					</div>
				</td>
				<th>íŒ€ëª…</th>
				<td><input type="text" th:data-teamno="${teamNo}" th:value="${teamName}" id="teamNo"></td>
			</tr>
			<input type="hidden" id="reportNo" th:value="${report[0].reportNo}">
			<tr>
				<th>ì§ê¸‰</th><!-- ë¡œê·¸ì¸í•œ ìœ ì € -->
				<td><input type="text" th:value="${position}"></td>
				<th>ì„±ëª…</th><!-- ë¡œê·¸ì¸í•œ ìœ ì € -->
				<td><input type="text" th:data-userno="${userNo}" th:value="${userName}" id="userNo"></td>
			</tr>
		</table>

		<h3>ì…ì¶œê¸ˆ ë‚´ì—­</h3>
		<div class="btn-group">
			<button class="btn plus" onclick="addRow()">ï¼‹ í–‰ ì¶”ê°€</button>
			<button class="btn minus" onclick="removeRow()">ï¼ í–‰ ì‚­ì œ</button>
			<input type="file" id="excelFile" />
			<button type="button" id="Excelupload">ì—‘ì…€ ì—…ë¡œë“œ</button>
		</div>

		<table id="financeTable">
			<thead>
				<tr>
					<th>ì¼ì</th>
					<th>ìƒì„¸ë‚´ì—­</th>
					<th>ì…ê¸ˆì•¡(ì›)</th>
					<th>ì¶œê¸ˆì•¡(ì›)</th>
					<th>ì”ì•¡(ì›)</th>
					<th>ì„ íƒ</th>
				</tr>
			</thead>
			<tbody>
				<tr th:each="r : ${report}">
					<td><input type="date" th:value="${#dates.format(r.transDate, 'yyyy-MM-dd')}" th:data-trans="${r.transId}" id="transId"></td>
					<td><input type="text" th:value="${r.purposeUse}"></td>
					<td><input type="number" th:data-deposit="ì…ê¸ˆ" th:value="${r.deposit}"></td>
					<td><input type="number" th:data-drawal="ì¶œê¸ˆ" th:value="${r.withdrawal}"></td>
					<td><input type="number" th:value="${r.balance}"></td>
					<td><input type="checkbox"></td>
				</tr>
			</tbody>
		</table>

		<div class="report-section">
			<h3>ì›”ê°„í•©ê³„</h3>
			<table class="sum-table">
				<thead>
					<tr>
						<th>ì…ê¸ˆì•¡(ì›)</th>
						<th>ì¶œê¸ˆì•¡(ì›)</th>
						<th>ì”ì•¡(ì›)</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><input type="number" readonly id="totalDeposit"></td>
						<td><input type="number" readonly id="totalWithdraw"></td>
						<td><input type="number" readonly id="totalBalance"></td>
					</tr>
				</tbody>
			</table>

			<h3>ì¶”ê°€ ìë£Œ ì²¨ë¶€</h3>
			<div class="attachment-area">
				<textarea placeholder="ì‚¬ì§„ / ê·¸ë˜í”„ ë“± ì²¨ë¶€" rows="5"></textarea>
			</div>

			<h3>ì²¨ë¶€ íŒŒì¼</h3>
			<div class="file-upload">
				<div>
					<input type="file">
					<button type="button">ì²¨ë¶€</button>
				</div>
				<div>
					<input type="file">
					<button type="button">ì²¨ë¶€</button>
				</div>
			</div>

			<div class="button-area">
				<button type="button" class="btn-approve">ê²°ì¬ì„ </button>
				<button type="button" class="btn-submit" id="updateReport">ì €ì¥</button>
			</div>
		</div>
	</div>
	</div>
	<script>

		function calculateTotals() {
			let totalDeposit = 0;
			let totalWithdraw = 0;
			let totalBalance = 0;
			let prevBalance = 0;

			const rows = document.querySelectorAll('#financeTable tbody tr');

			rows.forEach((row, index) => {
				const depositInput = row.cells[2].querySelector('input');
				const withdrawInput = row.cells[3].querySelector('input');
				const balanceInput = row.cells[4].querySelector('input');

				const deposit = parseInt(depositInput.value) || 0;
				const withdraw = parseInt(withdrawInput.value) || 0;

				let balance = 0;

				if (index === 0) {
					balance = deposit - withdraw;
				} else {
					balance = prevBalance + deposit - withdraw;
				}

				balanceInput.value = balance;

				prevBalance = balance;
				totalDeposit += deposit;
				totalWithdraw += withdraw;
				totalBalance = balance;
			});

			document.getElementById('totalDeposit').value = totalDeposit;
			document.getElementById('totalWithdraw').value = totalWithdraw;
			document.getElementById('totalBalance').value = totalBalance;
		}

		function attachInputListeners() {
			const tbody = document.querySelector('#financeTable tbody');
			tbody.querySelectorAll('input[type="number"]').forEach(input => {
				input.addEventListener('input', calculateTotals);
			});
		}

		// í–‰ ì¶”ê°€
		function addRow() {
			const tbody = document.querySelector('#financeTable tbody');
			const newRow = tbody.rows[0].cloneNode(true);
			newRow.querySelectorAll('input').forEach(input => {
				if (input.type === 'checkbox') input.checked = false;
				else input.value = '';
			});
			tbody.appendChild(newRow); 
			attachInputListeners(); // ìƒˆë¡œ ì¶”ê°€ëœ í–‰ì—ë„ ë¦¬ìŠ¤ë„ˆ ë¶™ì´ê¸°
			calculateTotals(); // ì¶”ê°€ í›„ ê³„ì‚° ë‹¤ì‹œ ì‹¤í–‰
		}

		// í–‰ ì‚­ì œ
		function removeRow() {
			const tbody = document.querySelector('#financeTable tbody');
			const rows = Array.from(tbody.rows);
			const checkedRows = rows.filter(row => row.querySelector('input[type="checkbox"]').checked);

			if (checkedRows.length > 0) {
				if (rows.length - checkedRows.length < 2) {
					alert("ë” ì´ìƒ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
					return;
				}
				checkedRows.forEach(row => row.remove());
			} else {
				if (rows.length <= 2) {
					alert("ë” ì´ìƒ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
					return;
				}
				tbody.deleteRow(rows.length - 1);
			}
			calculateTotals();
		}

		// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì‹¤í–‰
		window.onload = () => {
			attachInputListeners();
			calculateTotals();
		};


		// Report ë“±ë¡ AJAX

		// ë²„íŠ¼ í´ë¦­ì‹œ click ì´ë²¤íŠ¸

		document.querySelector('#updateReport').addEventListener('click', e => {
			updateReportAjax();
		})

		function updateReportAjax() {
    let rTitle = document.querySelector('#reportTitle').value;
    console.log("ğŸ“Œ reportTitle ì…ë ¥ê°’:", rTitle);
    let sDate = document.querySelector('#startDate').value;
    let eDate = document.querySelector('#endDate').value;
    let userNo = document.querySelector('#userNo').dataset.userno;
    let teamNoRaw  = document.querySelector('#teamNo').dataset.teamno;
    let teamNo = teamNoRaw.replace(/^ROLE_/, '');  // â†’ "T003"

    // 1. ê±°ë˜ ë‚´ì—­ ìˆ˜ì§‘
    let transList = [];
    document.querySelectorAll('#financeTable tbody tr').forEach(row => {
        let transDate = row.cells[0].querySelector('input').value;
        let purposeUse = row.cells[1].querySelector('input').value;
        let deposit = parseInt(row.cells[2].querySelector('input').value) || 0;
        let withdrawal = parseInt(row.cells[3].querySelector('input').value) || 0;
        let balance = parseInt(row.cells[4].querySelector('input').value) || 0;
        let transId = row.cells[0].querySelector('input').dataset.trans; 

        // ê±°ë˜ ì¼ìê°€ ë¹„ì–´ìˆìœ¼ë©´ skip
        if (transDate.trim() !== '') {
            transList.push({
            	transId: transId ? parseInt(transId) : null, // null í—ˆìš©
                transDate,
                purposeUse,
                deposit,
                withdrawal,
                balance
                
            });
        }
    });


    // 2. ìµœì¢… JSON ë°ì´í„° êµ¬ì„±
    const reportNo = document.querySelector('#reportNo').value;
    const data = {
        reportNo: parseInt(reportNo), 
        reportTitle: rTitle,
        transStart: sDate,
        transEnd: eDate,
        userNo: userNo,
        teamNo: teamNo,
        transHistoryList: transList
    };



	console.log("ğŸ“¦ reportNo (ì „ì†¡ ì „):", reportNo);
    // 3. fetch ìˆ˜ì • AJAX ìš”ì²­
    fetch(`/workmate/finance/reportUpdate/${reportNo}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
        .then(res => res.json())
        .then(result => {
            if (result.success) {
            console.log("ğŸ” ìµœì¢… ì „ì†¡ ë°ì´í„°:", JSON.stringify(data, null, 2));
                alert('ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
		        setTimeout(() => {
		  //  location.href = '/workmate/finance/reportList';
		}, 600); // ë¦¬í¬íŠ¸ ëª©ë¡ìœ¼ë¡œ ì´ë™
            } else {
                alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(err => {
            console.error('ì—ëŸ¬ ë°œìƒ:', err);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}


	</script>


</body>

</html>