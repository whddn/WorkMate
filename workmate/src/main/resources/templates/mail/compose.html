<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/mail_layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>메일 쓰기 | WorkMate</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
    .form-group { margin-bottom: 15px; }

    /* 에디터 */
    #editor-container {
        height: 400px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    /* 첨부파일 미리보기 */
    .file-preview { margin-top: 10px; }
    .file-preview span { display: block; padding: 3px 0; }

    /* 일반 텍스트 입력 */
    .compact-input {
        height: 38px;
        font-size: 14px;
        padding: 6px 12px;
        background-color: #fdfdfd;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-shadow: inset 0 1px 1px rgba(0,0,0,0.05);
        transition: border-color 0.2s;
    }
    .compact-input:focus {
        border-color: #0d6efd;
        outline: none;
        box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.2);
    }

    /* 드롭다운 select */
    select.form-control {
        height: 38px;
        font-size: 14px;
        padding: 6px 12px;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 140 140' xmlns='http://www.w3.org/2000/svg'%3E%3Cpolygon points='70,105 15,35 125,35' fill='%23666'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 10px;
        cursor: pointer;
        transition: border-color 0.2s;
    }
    select.form-control:focus {
        border-color: #198754;
        box-shadow: 0 0 0 0.15rem rgba(25, 135, 84, 0.2);
        outline: none;
    }
</style>

</head>
<body>
<div class="container mt-4">
    <h2 class="mb-4">메일 쓰기</h2>

    <form id="sendForm" th:action="@{/mail/send}" method="post" enctype="multipart/form-data" onsubmit="return prepareContent('send')">
        <div class="form-group">
            <label>보내는 사람</label>
            <div class="input-group">
                <input type="text" name="senderName" class="form-control compact-input" th:value="${#authentication.principal.userVO.userName}" readonly>
                <input type="text" name="senderEmail" class="form-control compact-input" th:value="${#authentication.principal.userVO.userMail}" readonly>
            </div>
        </div>

        <!-- 수신자 조직도 선택 -->
        <div class="form-group">
            <label>수신자 선택</label>
            <div class="d-flex gap-2">
                <select id="departmentSelect" class="form-control w-25 compact-input"><option value="">부서를 선택하세요</option></select>
                <select id="teamSelect" class="form-control w-25 compact-input"><option value="">팀 선택</option></select>
                <select id="employeeSelect" class="form-control w-50 compact-input">
                    <option value="">사원을 선택하세요</option>
                    <option value="ALL">(전체 팀 메일 발송)</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="recipients">받는 사람</label>
            <input type="text" id="recipients" name="recipients" class="form-control compact-input" placeholder="쉼표(,)로 구분" required>
        </div>

        <!-- 참조 조직도 선택 -->
        <div class="form-group">
            <label>참조 선택</label>
            <div class="d-flex gap-2">
                <select id="ccDepartmentSelect" class="form-control w-25 compact-input"><option value="">부서를 선택하세요</option></select>
                <select id="ccTeamSelect" class="form-control w-25 compact-input"><option value="">팀 선택</option></select>
                <select id="ccEmployeeSelect" class="form-control w-50 compact-input">
                    <option value="">사원을 선택하세요</option>
                    <option value="ALL">(전체 팀 메일 참조)</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="ccList">참조</label>
            <input type="text" id="ccList" name="ccList" class="form-control compact-input" placeholder="쉼표(,)로 구분">
        </div>

        <div class="form-group">
            <label for="subject">제목</label>
            <input type="text" id="subject" name="subject" class="form-control compact-input" required>
        </div>

        <div class="form-group">
            <label>본문</label>
            <div id="editor-container"></div>
            <input type="hidden" id="content" name="content" />
        </div>

        <div class="form-group">
            <label for="attachments">첨부 파일</label>
            <input type="file" id="attachments" name="attachments" class="form-control" multiple>
            <div class="file-preview" id="filePreview"></div>
        </div>
    </form>

    <form id="draftForm" th:action="@{/mail/saveDraft}" method="post" enctype="multipart/form-data" onsubmit="return prepareContent('draft')">
        <input type="hidden" name="senderName" th:value="${#authentication.principal.userVO.userName}" />
        <input type="hidden" name="senderEmail" th:value="${#authentication.principal.userVO.userMail}" />
        <input type="hidden" id="draftRecipients" name="recipients">
        <input type="hidden" id="draftCcList" name="ccList">
        <input type="hidden" id="draftSubject" name="subject">
        <input type="hidden" id="draftContent" name="content">
    </form>

    <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-primary" form="sendForm">보내기</button>
        <button type="submit" class="btn btn-secondary" form="draftForm">임시 저장</button>
    </div>
</div>

<script>
var quill = new Quill('#editor-container', {
    theme: 'snow',
    placeholder: '메일 내용을 입력하세요...'
});

function prepareContent(mode) {
    const html = quill.root.innerHTML;
    if (mode === 'send') {
        $('#content').val(html);
    } else {
        $('#draftRecipients').val($('#recipients').val());
        $('#draftCcList').val($('#ccList').val());
        $('#draftSubject').val($('#subject').val());
        $('#draftContent').val(html);
    }
    return true;
}

$(function () {
    $.get('/workmate/mail/departments', function (departments) {
        departments.forEach(d => {
            $('#departmentSelect, #ccDepartmentSelect').append(`<option value="${d.departmentId}">${d.departmentName}</option>`);
        });
    });

    $('#departmentSelect').change(function () {
        const deptId = $(this).val();
        $('#teamSelect').empty().append('<option value="">팀 선택</option>');
        $('#employeeSelect').empty().append('<option value="">사원 선택</option><option value="ALL">(전체 팀 메일 발송)</option>');
        $.get('/workmate/mail/teams', { departmentId: deptId }, function (teams) {
            teams.forEach(t => $('#teamSelect').append(`<option value="${t.teamNo}">${t.teamName}</option>`));
        });
    });

    $('#teamSelect').change(function () {
        const teamNo = $(this).val();
        $('#employeeSelect').empty().append('<option value="">사원 선택</option><option value="ALL">(전체 팀 메일 발송)</option>');
        $.get('/workmate/mail/employees', { teamNo }, function (emps) {
            emps.forEach(e => {
                $('#employeeSelect').append(`<option value="${e.userMail}">${e.userName} (${e.userMail})</option>`);
            });
        });
    });

    $('#employeeSelect').change(function () {
        const value = $(this).val();
        if (value === "ALL") {
            const teamNo = $('#teamSelect').val();
            $.get('/workmate/mail/emails', { teamNo }, function (emails) {
                const merged = $('#recipients').val().trim();
                $('#recipients').val(merged ? merged + ', ' + emails.join(', ') : emails.join(', '));
            });
        } else if (value) {
            const merged = $('#recipients').val().trim();
            $('#recipients').val(merged ? merged + ', ' + value : value);
        }
    });

    // 참조 조직도 처리
    $('#ccDepartmentSelect').change(function () {
        const deptId = $(this).val();
        $('#ccTeamSelect').empty().append('<option value="">팀 선택</option>');
        $('#ccEmployeeSelect').empty().append('<option value="">사원 선택</option><option value="ALL">(전체 팀 메일 참조)</option>');
        $.get('/workmate/mail/teams', { departmentId: deptId }, function (teams) {
            teams.forEach(t => $('#ccTeamSelect').append(`<option value="${t.teamNo}">${t.teamName}</option>`));
        });
    });

    $('#ccTeamSelect').change(function () {
        const teamNo = $(this).val();
        $('#ccEmployeeSelect').empty().append('<option value="">사원 선택</option><option value="ALL">(전체 팀 메일 참조)</option>');
        $.get('/workmate/mail/employees', { teamNo }, function (emps) {
            emps.forEach(e => {
                $('#ccEmployeeSelect').append(`<option value="${e.userMail}">${e.userName} (${e.userMail})</option>`);
            });
        });
    });

    $('#ccEmployeeSelect').change(function () {
        const value = $(this).val();
        if (value === "ALL") {
            const teamNo = $('#ccTeamSelect').val();
            $.get('/workmate/mail/emails', { teamNo }, function (emails) {
                const merged = $('#ccList').val().trim();
                $('#ccList').val(merged ? merged + ', ' + emails.join(', ') : emails.join(', '));
            });
        } else if (value) {
            const merged = $('#ccList').val().trim();
            $('#ccList').val(merged ? merged + ', ' + value : value);
        }
    });

    // 파일 미리보기
    $('#attachments').on('change', function () {
        const preview = $('#filePreview');
        preview.empty();
        Array.from(this.files).forEach(f => {
            preview.append(`<span>${f.name} (${(f.size / 1024).toFixed(1)} KB)</span>`);
        });
    });
});
</script>
</body>
</html>
