<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/mail_layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î≥¥ÎÇ∏ Î©îÏùºÌï® | WorkMate</title>
    <style>
        .w-25 {
            margin-left: 70%;
            padding-bottom: 10px;
        }
        .asd {
            padding-bottom: 10px;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h2 class="mb-4">Î≥¥ÎÇ∏ Î©îÏùºÌï®</h2>

    <!-- üîç Í≤ÄÏÉâÏ∞Ω -->
    <div class="input-group w-25">
        <input type="text" id="searchBox" class="form-control" placeholder="Í≤ÄÏÉâ...">
        <button class="btn btn-secondary" onclick="searchTable()">Í≤ÄÏÉâ</button>
    </div>

    <div class="card mt-3">
        <div class="card-body">

            <!-- ÏÇ≠Ï†ú/Ïù¥Îèô Î≤ÑÌäº ÏòÅÏó≠ -->
            <div class="asd d-flex gap-2">
                <!-- ‚úÖ ÏÇ≠Ï†ú Ìèº -->
                <form id="deleteForm" method="post" th:action="@{/mail/deleteSelected}">
                    <input type="hidden" name="mailIds" id="selectedMailIds">
                </form>

                <!-- ‚úÖ ÏÇ≠Ï†ú Î≤ÑÌäº (JS Ìï®Ïàò Ïó∞Í≤∞Îê®) -->
                <button class="btn btn-danger btn-sm" type="button" onclick="submitDelete()">ÏÇ≠Ï†ú</button>

                <!-- Ïù¥Îèô Î≤ÑÌäº -->
                <div class="btn-group">
                    <button class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        Ïù¥Îèô
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="moveToFolder(1001)">Î∞õÏùÄÎ©îÏùºÌï®</a></li>
                        <li><a class="dropdown-item" href="#" onclick="moveToFolder(1002)">Î≥¥ÎÇ∏Î©îÏùºÌï®</a></li>
                        <li><a class="dropdown-item" href="#" onclick="moveToFolder(1003)">ÏûÑÏãúÎ≥¥Í¥ÄÌï®</a></li>
                        <li><a class="dropdown-item" href="#" onclick="moveToFolder(1004)">Ïä§Ìå∏Î©îÏùºÌï®</a></li>
                        <li><a class="dropdown-item" href="#" onclick="moveToFolder(1006)">Ìú¥ÏßÄÌÜµ</a></li>
                        <li th:each="folder : ${myFolders}">
                            <a class="dropdown-item" href="#"
                               th:text="${folder.folderName}"
                               th:onclick="'moveToFolder(' + ${folder.folderId} + ')'">
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Ïù¥ÎèôÏö© form -->
                <form id="moveForm" method="post" th:action="@{/mail/moveSelected}">
                    <input type="hidden" name="mailIds" id="moveMailIds">
                    <input type="hidden" name="targetFolderId" id="targetFolderId">
                </form>
            </div>

            <!-- Î©îÏùº ÌÖåÏù¥Î∏î -->
            <table id="mailTable" class="table table-striped table-bordered">
                <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>Î∞õÎäî ÏÇ¨Îûå</th>
                    <th>Ï†úÎ™©</th>
                    <th>Ï≤®Î∂Ä</th>
                    <th>ÏòàÏïΩÏãúÍ∞Ñ</th>
                    <th>ÎÇ†Ïßú</th>
                </tr>
                </thead>
                <tbody id="mailBody">
                <tr th:if="${sentMails == null or #lists.isEmpty(sentMails)}">
                    <td colspan="6" class="text-center">Î≥¥ÎÇ∏ Î©îÏùºÏù¥ ÏóÜÏäµÎãàÎã§.</td>
                </tr>

                <tr th:each="mail : ${sentMails}" class="mail-row">
                    <td><input type="checkbox" class="mail-checkbox" th:value="${mail.mailId}"></td>
                    <td>
  <span class="badge bg-secondary me-1"
        th:text="${mail.status == 'Î∞úÏÜ°Îê®' ? 'Î≥¥ÎÇ∏ Î©îÏùº' : 'Î∞õÏùÄ Î©îÏùº'}"></span>
  <span th:text="${mail.recipients}"></span>
</td>
                    
                    <td>
                        <span th:if="${mail.reserStatus == 'ÏòàÏïΩÎê®'}" class="badge bg-warning text-dark me-1">ÏòàÏïΩÎê®</span>
                        <a th:href="@{/mail/sentview(mailId=${mail.mailId})}" th:text="${mail.subject}"></a>
                    </td>
                    <td th:if="${mail.attachmentCount > 0}">üìé</td>
                    <td th:if="${mail.attachmentCount == 0}"></td>
                    <td>
                        <span th:text="${#dates.format(mail.reserSendtime, 'yyyy-MM-dd HH:mm')}" th:if="${mail.reserStatus == 'ÏòàÏïΩÎê®'}"></span>
                    </td>
                    <td th:text="${#dates.format(mail.sentAt, 'yyyy-MM-dd HH:mm')}"></td>
                </tr>
                </tbody>
            </table>

            <!-- ‚úÖ ÌéòÏù¥Ïßï -->
            <nav th:if="${totalPage > 1}" aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
                        <a class="page-link" th:href="@{/mail/sent(page=1)}">&laquo;</a>
                    </li>
                    <li class="page-item" th:classappend="${currentPage <= 1} ? 'disabled'">
                        <a class="page-link" th:href="@{/mail/sent(page=${currentPage - 1})}">&lt;</a>
                    </li>
                    <li class="page-item" th:each="i : ${#numbers.sequence(startPage, endPage)}"
                        th:classappend="${i == currentPage} ? 'active'">
                        <a class="page-link" th:href="@{/mail/sent(page=${i})}" th:text="${i}"></a>
                    </li>
                    <li class="page-item" th:classappend="${currentPage >= totalPage} ? 'disabled'">
                        <a class="page-link" th:href="@{/mail/sent(page=${currentPage + 1})}">&gt;</a>
                    </li>
                    <li class="page-item" th:classappend="${currentPage == totalPage} ? 'disabled'">
                        <a class="page-link" th:href="@{/mail/sent(page=${totalPage})}">&raquo;</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- JS Ïä§ÌÅ¨Î¶ΩÌä∏ -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const selectAllCheckbox = document.getElementById("selectAll");
        const checkboxes = document.querySelectorAll(".mail-checkbox");

        selectAllCheckbox.addEventListener("change", function () {
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        });

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener("change", function () {
                selectAllCheckbox.checked = [...checkboxes].every(cb => cb.checked);
            });
        });
    });

    // üîç Í≤ÄÏÉâ
    function searchTable() {
        let input = document.getElementById("searchBox").value.toLowerCase();
        let rows = document.querySelectorAll("#mailBody .mail-row");

        rows.forEach(row => {
            let recipient = row.cells[1].textContent.toLowerCase();
            let subject = row.cells[2].textContent.toLowerCase();
            row.style.display = (recipient.includes(input) || subject.includes(input)) ? "" : "none";
        });
    }

    // üìÅ Ïù¥Îèô
    function moveToFolder(folderId) {
        const selected = [...document.querySelectorAll(".mail-checkbox:checked")];
        if (selected.length === 0) {
            alert("Ïù¥ÎèôÌï† Î©îÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
            return;
        }

        const ids = selected.map(cb => cb.value).join(",");
        document.getElementById("moveMailIds").value = ids;
        document.getElementById("targetFolderId").value = folderId;
        document.getElementById("moveForm").submit();
    }

    // üóë ÏÇ≠Ï†ú
    function submitDelete() {
        const selected = [...document.querySelectorAll(".mail-checkbox:checked")];
        if (selected.length === 0) {
            alert("ÏÇ≠Ï†úÌï† Î©îÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
            return;
        }

        const ids = selected.map(cb => cb.value).join(",");
        document.getElementById("selectedMailIds").value = ids;
        document.getElementById("deleteForm").submit();
    }
</script>

</body>
</html>
