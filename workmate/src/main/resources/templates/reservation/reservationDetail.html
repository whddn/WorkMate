<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/reservation_layout}"
	layout:fragment="content">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>예약 상세 정보</title>

<link rel="stylesheet"	href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">

<style>
.container {
	max-width: 1200px;
	margin: auto;
}

.equal-height {
	display: flex;
	flex-wrap: wrap;
}

.equal-height>div {
	display: flex;
	flex-direction: column;
}

.card {
	flex-grow: 1;
	display: flex;
	flex-direction: column;
	height: 100%;
}

.card-body {
	flex-grow: 1;
	display: flex;
	flex-direction: column;
	justify-content: center;
}

.reservation-image {
	max-width: 100%;
	height: auto;
	border-radius: 5px;
}

.time-table {
	display: grid;
	grid-template-columns: repeat(2, 1fr);
	gap: 10px;
}

.time-slot {
	padding: 10px;
	border: 1px solid #007bff;
	border-radius: 5px;
	text-align: center;
	cursor: pointer;
	background-color: #f8f9fa;
}

.time-slot.selected {
	background-color: #007bff;
	color: white;
}
</style>
</head>
<body>
<form th:action="@{/reservation/Info}"
						 method="POST" enctype="multipart/form-data">
	<div class="container mt-5">
		<div class="row equal-height">
			<!-- ✅ 캘린더 영역 -->
			<div class="col-md-6">
				<div class="card shadow-sm">
					<div class="card-header bg-primary text-white text-center">예약 진행 중</div>
					<div class="card-body">
						<div id="calendar">
						</div>
					</div>
				</div>
			</div>

			<!-- ✅ 시간 선택 영역 -->
			<div class="col-md-6">
				<div class="card shadow-sm">
					<div class="card-header bg-primary text-white text-center">시간 선택</div>
					<div class="card-body">
						<button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="toggleAllTimes()">전체 선택</button>
						<div class="time-table">
							<th:block th:each="hour : ${#numbers.sequence(6, 23)}">
								<div class="time-slot" th:id="'time'+${hour}" th:data-value="${hour + ':00 - ' + (hour+1) + ':00'}"
									onclick="toggleTime(this)">
									<span th:text="${hour + ':00 - ' + (hour+1) + ':00'}">
									</span>
								</div>
							</th:block>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="row equal-height mt-3">
			<!-- ✅ 이미지 영역 -->
			<div class="col-md-6">
				<div class="card shadow-sm">
					<div class="card-body text-center">
						<img th:src="|/workmate/upload/${reser.image}|" id="reser-image" alt="예약 이미지">
					</div>
				</div>
			</div>

			<!-- ✅ 예약 정보 입력 영역 -->
			<div class="col-md-6">
				<div class="card shadow-sm">
					<div class="card-header bg-success text-white text-center">예약 정보 입력</div>
					<div class="card-body">
							<!-- 서버로 넘겨줄 데이터들 -->
							<input type="hidden" name="commonNo" id="commonNo" th:value="${reser.commonNo}" />
							<input type="hidden" name="userNo" id="userNo" th:value="${reser.userNo}" />
							<input type="hidden" name="reservationTime" id="reservationTime" />
							
							<div class="mb-3">
								<label class="form-label">공용품 종류</label>
								 <input type="text"	class="form-control" name="commonKind"
								  id="reser-category" th:value="${reser.commonKind}" readonly>
							</div>
							<div class="mb-3">
								<label class="form-label">이름</label>
								 <input type="text" class="form-control" name="commonName"
								  id="reser-name" th:value="${reser.commonName}" readonly>
							</div>
							<div class="mb-3">
								<label class="form-label">이용 날짜</label>
								 <input type="date"	class="form-control" name="reservationDate">
							</div>
							<div class="mb-3">
								<label class="form-label">예약 내용</label>
								<textarea class="form-control" name="reservationDetails"
									rows="3" placeholder="예약 목적을 입력하세요"  th:text="${reser.content}">
								</textarea>
							</div>
							<div class="text-center">
								<button type="submit" class="btn btn-success">예약하기</button>
								<button type="reset" class="btn btn-danger">취소</button>
							</div>
						
					</div>
				</div>
			</div>
		</div>
	</div>
</form>
	<!-- ✅ JavaScript -->
	<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ko.js"></script>
	<script>
    
	document.addEventListener("DOMContentLoaded", function () {
	    loadCalendar();
	});
	
	// 캘린더
	function loadCalendar() {
	    var calendarEl = document.getElementById('calendar');
	    var calendar = new FullCalendar.Calendar(calendarEl, {
	        locale: 'ko',
	        initialView: 'dayGridMonth',
	        selectable: true,
	        editable: false,
	        height: 350,
	        events: function (fetchInfo, successCallback, failureCallback) {
	            fetch(`/api/reservation/main`)  // ✅ REST API를 호출하여 예약 데이터 가져오기
	                .then(response => response.json())
	                .then(data => {
	                    let events = data.map(reservation => ({
	                        title: reservation.title,
	                        start: reservation.start,
	                        backgroundColor: '#28a745',
	                        borderColor: '#28a745'
	                    }));
	                    successCallback(events);
	                })
	                .catch(error => {
	                    console.error('예약 데이터를 불러오는 중 오류 발생:', error);
	                    failureCallback(error);
	                });
	        },
	        dateClick: function (info) {
	            document.querySelector('input[name="reservationDate"]').value = info.dateStr;
	        }
	    });
	    calendar.render();
	}
	
	// 시간 선택
    function toggleTime(element) {
        element.classList.toggle("selected");
    }

	// 모든 시간 선택
    function toggleAllTimes() {
        const timeSlots = document.querySelectorAll(".time-slot");
        const allSelected = Array.from(timeSlots).every(slot => slot.classList.contains("selected"));
        timeSlots.forEach(slot => {
            if (allSelected) {
                slot.classList.remove("selected");
            } else {
                slot.classList.add("selected");
            }
        });
    }
	
	 // 폼 전송 전에 선택된 시간 값들을 숨은 input에 넣기
	    document.querySelector("form").addEventListener("submit", function () {
	        const selectedTimes = Array.from(document.querySelectorAll(".time-slot.selected"))
	            .map(slot => slot.dataset.value); // "08:00 - 09:00" 등
	        document.getElementById("reservationTime").value = selectedTimes.join(", ");
	    });

</script>

</body>
</html>
