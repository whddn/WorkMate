<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/attendance_layout}"
	layout:fragment="content">
<head>
	<meta charset="UTF-8">
	<title>ê·¼íƒœê´€ë¦¬</title>
	<style>
	.main-container {
	display: flex;
	width: 100%;
	align-items: flex-start; /* ìœ„ìª½ ì •ë ¬ */
	gap: 20px;
}

#card-left {
	width: 400px;
	height: 630px;
	padding: 30px;
	margin-top: 30px;
	margin-left: 30px;
	box-sizing: border-box;
	
}

.right-container {
	flex-grow: 1;
	padding: 30px 30px 0 0;
	box-sizing: border-box;
}

#card-center {
	width: 100%;
	padding: 20px;
	margin-bottom: 20px;
	box-sizing: border-box;
}

#card-right {
	width: 100%;
	margin: 0 auto 30px auto;
	padding: 30px;
	box-sizing: border-box;
}
	.date-box {
		font-size: 20px;
		margin-top: 30px;
	}

	.time-box {
		font-size: 40px;
		margin-bottom: 10px;
	}

	table {
		width: 100%;
		border-collapse: collapse;
		margin-top: 20px;
	}

	#card-work {
		padding: 40px;
		border: 2px solid #eee;
	}

	.table-container {
		max-height: 300px;
		overflow-y: auto;
		border: 1px solid #ccc;
		display: block;
	}

	.dropdown-work {
		margin-top: 80px;
	}

	.table-responsive {
		max-height: 400px;
		overflow-y: auto;
	}

	.inline-list {
		list-style-type: none;
		padding: 0;
		margin: 0;
		display: flex;
		gap: 10px;
	}

	.inline-list li {
		display: inline-flex;
		align-items: center;
	}
	#work-type{
		height: 42px;
	}
	
	</style>
</head>
<body>
	<div class="main-container">
		<div class="card" id="card-left">
			<div class="card-body">			
				<h4 class="card-title"><i class="fas fa-user"> [[${userName}]]ë‹˜, ê·¼íƒœí˜„í™©</i></h4>
				<p class="date-box" id="current-date"></p>
				<p class="time-box" id="current-time"></p>
				<p>ğŸ•˜ <b>ì¶œê·¼ì‹œê°„ : </b> <span id="start-time">[[${attend} != null ? ${#dates.format(attend.startWork, 'HH:mm')} : ë¯¸ë“±ë¡ ]]</span></p>
				<p>ğŸ•• <b>í‡´ê·¼ì‹œê°„ : </b> <span id="end-time">[[${attend} != null ? ${#dates.format(attend.afterWork, 'HH:mm')} : ë¯¸ë“±ë¡ ]]</span></p>

				<form action="startWork" th:if="${attend} == null">
					<button class="btn btn-primary btn-fw" id="workStart">ì¶œê·¼í•˜ê¸°</button>
				</form>
				<form action="afterWork" th:if="${attend} != null and ${attend.afterWork} == null">
					<input type="hidden" name="workNo" th:value="${attend.workNo}">
					<button class="btn btn-secondary btn-fw">í‡´ê·¼í•˜ê¸°</button>
				</form>

				<div class="dropdown-work" style="display: inline-flex; align-items: center; gap: 10px;">
					<select id="work-type" class="form-select input-fixed">
						<option value="">ê·¼ë¬´íƒ€ì…ì„ íƒ</option>
						<option value="/workmate/approval/write?apprType=AF001">ì—°ì°¨</option>
						<option value="/workmate/approval/write?apprType=AF005">ì¬íƒ</option>
						<option value="/workmate/approval/write?apprType=AF002">ì¶œì¥</option>
					</select>
					<button onclick="applyWorkType()" class="btn btn-primary btn-fw">ì‹ ì²­</button>
				</div>
			</div>
		</div>
		
		<!-- ì˜¤ë¥¸ìª½ (center card) -->
		<div class="right-container">
			<div class="card" id="card-center">
				<div class="card-body">
					<div class="container mt-4">
						<div class="user-icon">
							<h4 class="card-title">ì´ë²ˆë‹¬ ê·¼ë¬´ ì‹œê°„ </h4>
							<p class="text-muted">ì„ íƒì  ê·¼ë¡œì‹œê°„ [9:00 ~ 18:00]</p>
						</div>
						<div class="col-10">
							<div class="card" id="card-work">
								<div class="card-body">
									<strong><h2 id="current-month"></h2></strong>
									<p> [ì£¼ 52ì‹œê°„ ê¸°ì¤€ ì£¼ê°„ ê·¼ë¬´ì‹¤ì ]</p>
									<div class="d-flex justify-content-between">
										<h3 class="text-info fw-bold">ì›” ê·¼ë¬´ì‹œê°„</h3>
										<h1 class="text-info fw-bold" th:text="${totalWorkTime} + 'h'"></h1>
									</div>
									<div class="progress progress-sm" style="height: 22px;">
										<div class="progress-bar bg-info" role="progressbar"
											th:style="'width:' + ((${totalWorkTime} - ${addWorkTime}) / 208.0 * 100) + '%'"
											th:aria-valuenow="${totalWorkTime} - ${addWorkTime}" aria-valuemin="0" aria-valuemax="208">
										</div>
										<div class="progress-bar bg-success" role="progressbar"
											th:style="'width:' + (${addWorkTime} / 208.0 * 100) + '%'"
											th:aria-valuenow="${addWorkTime}" aria-valuemin="0" aria-valuemax="208">
										</div>
									</div>
									<div class="d-flex justify-content-between mt-2">
										<p class="text-muted mb-0"><b>ë‚¨ì€ ê·¼ë¬´ì‹œê°„</b></p>
										<p class="text-muted mb-0" th:text="${remainWorkTime} + 'h / 209h'"></p>
									</div>
									<div class="d-flex justify-content-between mt-2">
										<p class="text-muted mb-0"><b>ì§€ê° / ì¡°í‡´ íšŸìˆ˜</b></p>
										<p class="text-primary">
											<span th:if="${not #lists.isEmpty(works)}" th:text="${works[0].statusCount} + 'ë²ˆ'"></span>
										</p>
									</div>
								</div>
								<div id="work-info">
									<hr>
									<ul class="inline-list">
										<li><p class="text-primary">â— </p> ì •ìƒê·¼ë¬´</li>
										<li><p class="text-success">â— </p> ì—°ì¥ê·¼ë¬´</li>
									</ul>
								</div>
							</div>
						</div>
					</div>				
				</div>
			</div>
		</div>
	</div>

	<!-- card-rightëŠ” main-container ì•„ë˜ ì „ì²´ ë„ˆë¹„ë¡œ ë°°ì¹˜ -->
	<div class="card" id="card-right">
		<div class="card-body">
			<h4 class="card-title">ì´ë²ˆë‹¬ ê·¼íƒœ í˜„í™©</h4>
			<div class="table-responsive">
				<table class="table">
					<thead>
						<tr>
							<th>ë‚ ì§œ</th>
							<th>ì¶œê·¼ì‹œê°„</th>
							<th>í‡´ê·¼ì‹œê°„</th>
							<th>ê·¼ë¬´ì‹œê°„</th>
							<th>ì—°ì¥ê·¼ë¬´ì‹œê°„</th>
							<th>ê·¼ë¬´ìƒíƒœ</th>
							<th>ì‚¬ìœ ì œì¶œ</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="work : ${works}">
							<td>[[ ${#dates.format(work.startWork, 'yyyy-MM-dd')} ]]</td>
							<td>[[ ${#dates.format(work.startWork, 'HH:mm')} ]]</td>
							<td>[[ ${#dates.format(work.afterWork, 'HH:mm')} ]]</td>
							<td>[[ ${work.workTime} ]] h</td>
							<td>[[ ${work.addWorkTime} ]] h</td>
							<td>[[ ${work.workStatus} ]]</td>
							<td>
							[[ ${work.lateReason} ]]
								<button class="btn btn-info" 
									th:if="${work.workStatus == 'ì§€ê°'} and (${work.lateReason} == null or ${work.lateReason} == '')" 
									th:onclick="'showLateReasonModal(' + ${work.workNo} + ')'">
									<b>ì§€ê°ì‚¬ìœ  ì œì¶œ ï¼</b>
								</button>
							</td> 
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>	
		<!-- Modal -->
				<div class="modal fade" id="addRowModal" tabindex="-1" role="dialog" aria-hidden="true" >
				    <div class="modal-dialog" role="work">
				        <div class="modal-content">
				            <div class="modal-header border-0">
				                <h5 class="modal-title"><b>ì§€ê° ì‚¬ìœ </b></h5>
				                <button type="button" class="close" onclick="closeModal()">
				                    <span aria-hidden="true">Ã—</span>
				                </button>
				            </div>
				            <div class="modal-body">
				                <p class="small">ì§€ê° ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
				                <form id="uploadForm" method="post" name="uploadForm" action="/workmate/attendance/lateReason" onsubmit="return validateForm()">
				                    <input type="hidden" name="workNo" id="workNoHidden">
				                    <div class="row">
				                        <div class="col-sm-12">
				                            <div class="form-group form-group-default">
				                                <label>ë‚´ìš©</label>
				                                <input id="addName" name="lateReason" type="text" class="form-control" placeholder="ì§€ê°ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
				                            </div>
				                  		</div>				                        
				                    </div>
				                    <div class="modal-footer border-0">
				            		<button type="submit" id="addRowButton" class="btn btn-primary" >ì œì¶œ</button>
				                	<button type="button" class="btn btn-danger" onclick="closeModal()">ì·¨ì†Œ</button>
				            		</div>
				                </form>
				            </div>				            
				        </div>
				    </div>
				</div>
	

	<script th:inline="javascript">
		const msg = [[${msg}]];
		if(msg != null){
			alert(msg);
		}
		function showLateReasonModal(workNo) {
		    // hidden inputì— workNo ê°’ ì„¤ì •
		    document.getElementById("workNoHidden").value = workNo;
		    // ëª¨ë‹¬ ì—´ê¸°
		    const modal = new bootstrap.Modal(document.getElementById('addRowModal'));
		    modal.show();
		}
		
		// íŒŒì¼ ë“±ë¡ ëª¨ë‹¬
		function uploadModal() {
		    var modal = new bootstrap.Modal(document.getElementById('addRowModal'));
		    modal.show();
		}

		function closeModal() {
		    var modalElement = document.getElementById('addRowModal');
		    var modalInstance = bootstrap.Modal.getInstance(modalElement);
		    
		    if (modalInstance) {
		        modalInstance.hide();
		    }

		    // backdrop ê°•ì œ ì œê±°
		    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
		}
		
		function validateForm() {
		    var reason = document.getElementById("addName").value.trim();
		    if (reason === "") {
		        alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
		        return false; // ì œì¶œ ì¤‘ë‹¨
		    }
		    return true; // ì œì¶œ ì§„í–‰
		}
		
		// í˜„ì¬ì‹œê°„ê°€ì ¸ì˜¤ê¸°
		function currentDate() {
			const now = new Date();
			document.getElementById("current-date").innerText = now.toISOString().split('T')[0];
			document.getElementById("current-month").innerText = now.toISOString().split('-')[1] + "ì›”";
			document.getElementById("current-time").innerText = now.toLocaleTimeString();
		}
		setInterval(currentDate, 1000);
		currentDate();

		function applyWorkType() {
			var selectedUrl = document.getElementById("work-type").value;
			if (!selectedUrl) {
				alert("ê·¼ë¬´ íƒ€ì…ì„ ì„ íƒí•˜ì„¸ìš”!");
				return;
			}
			window.location.href = selectedUrl;
		}
		
		function applyWorkType() {
			var selectedUrl = document.getElementById("work-type").value;
			if (!selectedUrl) {
				alert("ê·¼ë¬´ íƒ€ì…ì„ ì„ íƒí•˜ì„¸ìš”!");
				return;
			}
			window.location.href = selectedUrl;
		}

		
	</script>
</body>
</html>
