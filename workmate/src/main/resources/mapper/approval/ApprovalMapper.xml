<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.workmate.app.approval.mapper.ApprovalMapper">
	<select id="selectApprovalList" parameterType="ApprovalVO" resultType="ApprovalVO">
		SELECT appr_no
		    , form_name
		    , appr_title
		    , user_name
		    , department_name
		    , create_date
		FROM approval
		    JOIN appr_form
		    ON approval.appr_type=appr_form.appr_type
		    JOIN employee
		    ON approval.user_no=employee.user_no
		    LEFT JOIN department
		    ON approval.dept_no=department.department_id
		WHERE appr_status=#{apprStatus}
	</select>
	<select id="selectApproval" parameterType="ApprovalVO" resultType="ApprovalVO">
		SELECT appr_no
			, appr_title
			, appr_content
			, create_date
		    , expire_date
		    , appr_status
			, department_name
			, approval.user_no
			, user_name
			, form_name
			, form_path
		FROM approval
		    JOIN appr_form
		    ON approval.appr_type=appr_form.appr_type
		    JOIN employee
		    ON approval.user_no=employee.user_no
		    LEFT JOIN department
		    ON approval.dept_no=department.department_id
		WHERE appr_no=#{apprNo}
	</select>
	<insert id="insertApproval" parameterType="ApprovalVO">
	    <!-- INSERT 전 새 apprNo 생성 -->
	    <selectKey keyProperty="apprNo" resultType="String" order="BEFORE">
	        SELECT 'YD' || LPAD(NVL(MAX(TO_NUMBER(SUBSTR(appr_no, 3))), 0) + 1, 3, '0')
	        FROM approval
	    </selectKey>
	    INSERT INTO approval
	    VALUES(#{apprNo}
	    	, #{apprTitle}
	    	, #{apprContent}
	    	, SYSDATE
	    	, SYSDATE + INTERVAL '1' YEAR
	    	, 'a1'
	    	, #{deptNo}
	    	, null
	    	, #{reportNo}
	    	, #{userNo}
	    	, #{reserNo}
	    	, #{apprType}
	    )
	</insert>
	<update id="updateApprovalStatus" parameterType="ApprovalVO">
		<selectKey keyProperty="apprNo" resultType="String" order="BEFORE">
	        SELECT 'YD' || LPAD(NVL(MAX(TO_NUMBER(SUBSTR(appr_no, 3))), 0) + 1, 3, '0')
	        FROM approval
	    </selectKey>
	    UPDATE approval a
	    SET a.appr_status = (
	        CASE 
	            WHEN NOT EXISTS (SELECT 1 FROM appr_elmnt e WHERE e.appr_no = #{apprNo} AND e.appr_result = 'a3') 
	                 AND EXISTS (SELECT 1 FROM appr_elmnt e WHERE e.appr_no = #{apprNo} AND e.appr_result = 'a2') 
	            THEN 'a2'
	            WHEN EXISTS (SELECT 1 FROM appr_elmnt e WHERE e.appr_no = #{apprNo} AND e.appr_result = 'a3') 
	            THEN 'a3'
	            ELSE a.appr_status
	        END
	    )
	    WHERE a.appr_no = #{apprNo}
	</update>
	<update id="updateApprovalDate" parameterType="ApprovalVO">
		UPDATE approval
		SET appr_date = SYSDATE
		WHERE appr_no = #{apprNo} 
    		AND appr_status IN ('a2', 'a3')
	</update>
	<delete id="deleteApproval" parameterType="ApprovalVO">
		DELETE FROM approval
		WHERE appr_no = #{apprNo}
			and user_no = #{userNo}
			AND appr_status = 'a1'
	</delete>
</mapper>