<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.workmate.app.employee.mapper.EmpMapper">
	<!-- ÏÇ¨Ïõê Ï†ÑÏ≤¥ Ï°∞Ìöå (Ï°∞ÏßÅÎèÑ/ÏÇ¨ÏõêÏù¥Î¶Ñ/Î∂ÄÏÑúÎ™Ö) -->
	<select id="selectAllEmpList" resultType="EmpVO">
	  SELECT 
	      USER_NO
	      , USER_NAME
	      , USER_MAIL
	      , USER_PHONE
	  FROM EMPLOYEE
	  ORDER BY USER_NO
	</select>
	<!-- Ïù¥ÎØ∏ Î∂ÄÏÑúÏû•ÏúºÎ°ú Îì±Î°ùÎêú ÏÇ¨Ïõê Ï°∞Ìöå ÏøºÎ¶¨ -->
	<select id="selectDepartmentHeadList" resultType="Integer">
	    SELECT d.DEPARTMENT_HEAD
	    FROM DEPARTMENT d
	    WHERE d.DEPARTMENT_HEAD IS NOT NULL
	</select>
	
	<!--/* Ï°∞ÏßÅÎèÑÏùò ÏÇ¨Ïõê ÏÉÅÏÑ∏ Ï°∞Ìöå */-->
	<select id="selectEmpById" resultType="EmpVO">
		SELECT u.user_name
		        , d.department_name
		        , d.department_id
		        , t.team_name
                , u.team_no
		        , u.user_position
		        , u.user_no
		        , u.user_id
		        , u.hire_date
		        , u.resign_date
		        , u.user_phone
		        , u.address
		        , u.user_ip
		        , u.common_ip
		FROM employee u 
		LEFT JOIN team t 
		ON u.team_no = t.team_no
        LEFT JOIN department d 
		ON t.department_id = d.department_id
		WHERE u.user_no = #{userNo}
	</select>
	

	<!-- ÏßÅÍ∏â Ï°∞Ìöå -->
	<select id="selectEmpPositionList" resultType="EmpVO">
		SELECT code_name
			, code
		FROM common_code
		WHERE group_code = '0Q' 
		AND code IS NOT NULL
        AND code LIKE '%q%'
	</select>
	
	<!-- ÏÇ¨Ïõê Îì±Î°ù --> 
	<insert id="insertEmployee" parameterType="EmpVO">
		<selectKey keyProperty="userNo"
				   resultType="Integer"
				   order="BEFORE">
		 SELECT MAX(USER_NO) + 1
         FROM EMPLOYEE
         WHERE USER_NO BETWEEN 200 AND 700
		</selectKey>
		INSERT INTO employee 
					(
    					 USER_NO
                       , USER_NAME
    				   , TEAM_NO
    				   , USER_POSITION
    				   , USER_ID
    				   , USER_PWD
    				   , USER_PHONE
    				   , ADDRESS
    				   , USER_MAIL
    				   , HIRE_DATE
    				   , STATUS_USER
					) 
		VALUES 		
					(
						#{userNo}
                      , #{userName}
					  , #{teamNo}
					  , ( SELECT CODE_NAME
					  	  FROM COMMON_CODE
					  	  WHERE CODE = #{userPosition} )
					  , 'user' || #{userNo}
					  , #{userPwd}
					  , #{userPhone}
					  , #{address}
					  , 'user' || #{userNo} || '@example.com'
					  , SYSDATE
					  , 'Ïû¨ÏßÅ'
					)
	</insert>
	<!-- ÏÇ¨Ïõê ÏàòÏ†ï -->
	<update id="updateEmployee" parameterType="EmpVO">
		UPDATE employee 
		SET
              USER_NAME = #{userName}
            , TEAM_NO =  #{teamNo}
            , HIRE_DATE = #{hireDate}
    		, USER_POSITION = #{userPosition}
    		, USER_PHONE = #{userPhone}
    		, ADDRESS = #{address}

        WHERE user_no = #{userNo}
	</update>
	
    <!-- Î∂ÄÏÑú Î∞è ÌåÄÎ≥Ñ ÏÇ¨Ïõê Ï°∞Ìöå -->
	<select id="selectEmpNameList" resultMap="departTeamMap">
		SELECT 
		          d.department_id
		        , d.department_name
		        , t.team_no
		        , t.team_name
		        , e.user_name
		        , e.user_id
		        , e.user_no
		FROM team t
		LEFT JOIN department d
		ON t.department_id = d.department_id
		LEFT JOIN employee e 
		ON e.team_no = t.team_no
		ORDER BY e.user_no
	</select>
	
		<!-- collection -->
	<resultMap id="departTeamMap" type="DepartmentVO">	
		<id property="departmentId" column="department_id" />
		<result property="departmentName" column="department_name" />
			<collection property="teamList" ofType="TeamVO">
				<result property="teamNo" column="team_no" />
				<result property="teamName" column="team_name" />
					<collection property="empList" ofType="EmpVO">
						<result property="userName" column="user_name" />
						<result property="userNo" column="user_no" />
					</collection>
			</collection>
	</resultMap> 
	<!-- ÌèâÍ∞ÄÌï¥Ïïº ÌïòÎäî ÌéòÏù¥ÏßÄ Îã®Í±¥ Ï°∞Ìöå -->
	<select id="selectEvaluList" resultType="EvaluVO">
		SELECT i.EVALU_SUMMARY
		      , ef.EVALU_NO
		      , i.EVALU_COMPET
		      , i.EVALU_CONTENT
		      , f.EVALU_NAME
		 FROM EVALU_ITEM i 
		 JOIN EVALU_FORMAT ef
		   ON i.EVALU_ITEM_NO = ef.EVALU_ITEM_NO
		 JOIN EVALU_FORM f 
		   ON f.EVALU_FORM_NO = ef.EVALU_FORM_NO
		WHERE f.EVALU_FORM_NO = #{evaluFormNo}
	</select>

	<!-- ÏßÄÎÇú ÌèâÍ∞Ä Î¶¨Ïä§Ìä∏ Ï°∞Ìöå (Ï†ÑÏ≤¥ Ï∂úÎ†• / Í¥ÄÎ¶¨Ïûê) -->
	<select id="selectBeforeEvaluList" resultType="EvaluVO">
		SELECT f.EVALU_NAME
            , f.USAGE_STATUS 
            , f.EVALU_START
            , f.EVALU_END
            , f.EVALU_FORM_NO
            , t.team_name
            , t.team_no
		FROM EVALU_FORM f
        JOIN EVALUATEE_GROUP eg
        ON eg.EVALU_FORM_NO = f.EVALU_FORM_NO 
        JOIN EMPLOYEE u
        ON u.USER_NO = eg.USER_NO
        JOIN TEAM t
        ON t.TEAM_NO = u.TEAM_NO
		ORDER BY EVALU_FORM_NO DESC
	</select>
	<!--  ÎÇ¥Í∞Ä ÌèâÍ∞ÄÏûêÎ°úÏÑú ÏßÑÌñâÌïú ÌèâÍ∞Ä Ìï≠Î™© + Ï†êÏàò Îã®Í±¥ Ï°∞Ìöå (formNo, userNo Í∏∞Ï§Ä)-->
	<select id="selectMyEvaluingById" resultType="EvaluVO">
		  SELECT 
			    ee.USER_NO
			    , ee.USER_NAME             
			    , i.EVALU_COMPET                       
			    , i.EVALU_CONTENT                      
			    , r.EVALU_SCORE AS evaluScore         
			    , fm.ORDER_NO                           
		  FROM EVALU_RESULT r
		  JOIN EVALU_GROUP eg 
		    ON r.EVALU_GROUP_ID = eg.EVALU_GROUP_ID         
		  JOIN EVALUATEE_GROUP eeg 
		    ON r.EVALUATEE_GROUP_ID = eeg.EVALUATEE_GROUP_ID  
		  JOIN EMPLOYEE ee 
		    ON eeg.USER_NO = ee.USER_NO                        
		  JOIN EVALU_FORMAT fm 
		    ON r.EVALU_NO = fm.EVALU_NO
		  JOIN EVALU_ITEM i ON fm.EVALU_ITEM_NO = i.EVALU_ITEM_NO
		  WHERE eg.USER_NO = #{userNo}                                        
		    AND r.EVALU_FORM_NO = #{evaluFormNo}          
		  ORDER BY ee.USER_NO, fm.ORDER_NO
		
	</select>
	<!-- ÌèâÍ∞Ä Í≤∞Í≥º Îã®Ïàú Ï°∞Ìöå - Î™©Î°ù Î∂àÎü¨Ïò¥ (Í¥ÄÎ¶¨Ïûê, formNo Í∏∞Î∞ò) -->
		<select id="selectAdminBeforeEvaluById" resultType="EvaluVO">
				SELECT    
			      f.EVALU_FORM_NO,
			      f.EVALU_NAME,              
			      f.EVALU_START,               
			      u.USER_NO,
			      u.USER_NAME,          
			      i.EVALU_COMPET,       
			      i.EVALU_CONTENT,
			      fm.ORDER_NO,
			      d.DEPARTMENT_NAME,
			      t.TEAM_NAME,
			      fm.EVALU_NO,
			      r.EVALU_SCORE,  
				      (
				        SELECT ROUND(AVG(r2.EVALU_SCORE), 1)
				        FROM EVALU_RESULT r2
				        JOIN EVALU_FORMAT fm2 ON r2.EVALU_NO = fm2.EVALU_NO
				        WHERE fm2.EVALU_ITEM_NO = i.EVALU_ITEM_NO
				          AND r2.EVALU_FORM_NO = f.EVALU_FORM_NO
				      ) AS avgScore
				FROM EVALU_FORM f              
				JOIN EVALUATEE_GROUP g ON f.EVALU_FORM_NO = g.EVALU_FORM_NO
				JOIN EMPLOYEE u ON g.USER_NO = u.USER_NO        
				JOIN EVALU_FORMAT fm ON fm.EVALU_FORM_NO = f.EVALU_FORM_NO  
				JOIN EVALU_ITEM i ON i.EVALU_ITEM_NO = fm.EVALU_ITEM_NO 
				JOIN TEAM t ON t.TEAM_NO = u.TEAM_NO
				JOIN DEPARTMENT d ON t.DEPARTMENT_ID = d.DEPARTMENT_ID
				JOIN EVALU_RESULT r ON r.EVALU_NO = fm.EVALU_NO
				                    AND r.EVALU_FORM_NO = f.EVALU_FORM_NO
                                    AND r.EVALUATEE_GROUP_ID = g.EVALUATEE_GROUP_ID
				
				WHERE f.EVALU_FORM_NO = #{evaluFormNo}
				ORDER BY u.USER_NO
			
	</select>
	
	<!-- Í¥ÄÎ¶¨Ïûê Îã®Í±¥ Ï°∞Ìöå - Í∞úÏù∏Ïóê ÎåÄÌïú Í≤∞Í≥º ÏøºÎ¶¨Î¨∏ -->
	<select id="selectAdminBeforeUserEvaluById"  parameterType="EvaluVO" resultType="EvaluVO">
					SELECT 
						    f.EVALU_FORM_NO,
						    f.EVALU_NAME,
						    f.EVALU_START,
						    u.USER_NO,
						    u.USER_NAME,
						    i.EVALU_COMPET,
						    i.EVALU_CONTENT,
						    fm.ORDER_NO,
						    d.DEPARTMENT_NAME,
						    t.TEAM_NAME,
						    fm.EVALU_NO,
						    
						    -- ÌèâÍ∑† Ï†êÏàò (ÏÑ†ÌÉù Ïú†Ï†Ä Í∏∞Ï§Ä)
						    ROUND(AVG(r.EVALU_SCORE), 1) AS avgScore,
						
						    -- Îã§Î•∏ ÌîºÌèâÍ∞ÄÏûêÎì§Ïùò ÌèâÍ∑† Ï†êÏàò (JOINÏúºÎ°ú Í∞ÄÏ†∏Ïò¥)
						    ROUND(other.avg_score, 1) AS otherAvgScore
						
						FROM EVALU_FORM f
						JOIN EVALUATEE_GROUP eg ON f.EVALU_FORM_NO = eg.EVALU_FORM_NO
						JOIN EMPLOYEE u ON eg.USER_NO = u.USER_NO
						JOIN EVALU_FORMAT fm ON fm.EVALU_FORM_NO = f.EVALU_FORM_NO
						JOIN EVALU_ITEM i ON i.EVALU_ITEM_NO = fm.EVALU_ITEM_NO
						JOIN TEAM t ON t.TEAM_NO = u.TEAM_NO
						JOIN DEPARTMENT d ON d.DEPARTMENT_ID = t.DEPARTMENT_ID
						JOIN EVALU_RESULT r ON r.EVALU_NO = fm.EVALU_NO
						                    AND r.EVALU_FORM_NO = f.EVALU_FORM_NO
						                    AND r.EVALUATEE_GROUP_ID = eg.EVALUATEE_GROUP_ID
						
						-- üîΩ Îã§Î•∏ ÏÇ¨ÎûåÎì§Ïùò ÌèâÍ∑† Ï†êÏàò ÌÖåÏù¥Î∏î LEFT JOIN (Ïù¥Î¶ÑÎßå Îã§Î•¥Í≤å avg Ï≤òÎ¶¨)
						LEFT JOIN (
						    SELECT 
						        fm2.EVALU_ITEM_NO,
						        r2.EVALU_FORM_NO,
						        ROUND(AVG(r2.EVALU_SCORE), 1) AS avg_score
						    FROM EVALU_RESULT r2
						    JOIN EVALUATEE_GROUP eg2 ON r2.EVALUATEE_GROUP_ID = eg2.EVALUATEE_GROUP_ID
						    JOIN EVALU_FORMAT fm2 ON r2.EVALU_NO = fm2.EVALU_NO
						    WHERE eg2.USER_NO != #{userNo}
						    GROUP BY fm2.EVALU_ITEM_NO, r2.EVALU_FORM_NO
						) other
						    ON fm.EVALU_ITEM_NO = other.EVALU_ITEM_NO
						   AND f.EVALU_FORM_NO = other.EVALU_FORM_NO
						
						WHERE f.EVALU_FORM_NO = #{evaluFormNo}
						  AND u.USER_NO = #{userNo}
						
						GROUP BY 
						    f.EVALU_FORM_NO, f.EVALU_NAME, f.EVALU_START,
						    u.USER_NO, u.USER_NAME,
						    i.EVALU_COMPET, i.EVALU_CONTENT,
						    fm.ORDER_NO,
						    d.DEPARTMENT_NAME, t.TEAM_NAME,
						    fm.EVALU_NO,
						    other.avg_score
						
						ORDER BY fm.ORDER_NO

	</select>
	
	<!-- ÏßÑÌñâÌï† ÌèâÍ∞Ä Ï°∞Ìöå 1Í±¥ / ÎÇ¥Í∞Ä ÌèâÍ∞ÄÏûê Í∑∏Î£πÏúºÎ°ú Îì±Î°ùÎêòÏñ¥ ÏûàÎäî ÌèºÏóê ÎåÄÌïú ÌîºÌèâÍ∞ÄÏûê Ï†ïÎ≥¥ÏôÄ Îì±Î°ùÎêú ÌèâÍ∞ÄÌèº Ï°∞Ìöå -->
	<select id="selectOneEvaluById" resultType="EvaluVO">
		SELECT
		    f.EVALU_FORM_NO
		    , f.EVALU_NAME
		    , f.USAGE_STATUS
		    , fm.ORDER_NO
		    , fm.EVALU_NO
		    , i.EVALU_ITEM_NO
		    , i.EVALU_COMPET
		    , i.EVALU_CONTENT
		    , u.USER_NO          
		    , u.USER_NAME
		    , t.TEAM_NAME
		    , d.DEPARTMENT_NAME
		    , evalUser.USER_NO   
		    , evalUser.USER_NAME 
		    , g.EVALU_GROUP_ID
		    , eg.EVALUATEE_GROUP_ID 

		FROM EVALU_FORM f
		JOIN EVALUATEE_GROUP eg ON eg.EVALU_FORM_NO = f.EVALU_FORM_NO
		JOIN EMPLOYEE u ON u.USER_NO = eg.USER_NO  
		JOIN TEAM t ON t.TEAM_NO = u.TEAM_NO
		JOIN DEPARTMENT d ON d.DEPARTMENT_ID = t.DEPARTMENT_ID
		JOIN EVALU_FORMAT fm ON fm.EVALU_FORM_NO = f.EVALU_FORM_NO
		JOIN EVALU_ITEM i ON i.EVALU_ITEM_NO = fm.EVALU_ITEM_NO
		JOIN EVALU_GROUP g ON g.EVALU_FORM_NO = f.EVALU_FORM_NO
		JOIN EMPLOYEE evalUser ON g.USER_NO = evalUser.USER_NO  
		WHERE f.EVALU_FORM_NO = #{evaluFormNo}
		  AND g.USER_NO = #{userNo}  
		ORDER BY u.USER_NO, fm.ORDER_NO
	</select>

	<!-- ÎÇ¥Í∞Ä ÌèâÍ∞ÄÌïú ÌèâÍ∞Ä Î¶¨Ïä§Ìä∏ (Ï†ÑÏ≤¥ Ï°∞Ìöå)-->
	<select id="selectMyEvaluList" resultMap="formEmpMyList">
	SELECT DISTINCT 
		f.EVALU_NAME,
		f.EVALU_FORM_NO,
		f.EVALU_START,
		f.EVALU_END,
		t.TEAM_NAME,
		g.USAGE_STATUS,
		f.EVALU_START,
		f.EVALU_END 
	FROM EVALU_GROUP g
	JOIN EVALU_FORM f ON g.EVALU_FORM_NO = f.EVALU_FORM_NO
	JOIN EMPLOYEE u ON g.USER_NO = u.USER_NO
	JOIN TEAM t ON t.TEAM_NO = u.TEAM_NO
	WHERE g.USER_NO = #{userNo}
	AND f.EVALU_FORM_NO IN ( SELECT EVALU_FORM_NO
					                FROM EVALU_GROUP
					                WHERE USER_NO = #{userNo} )
	ORDER BY f.EVALU_FORM_NO DESC
</select>
	
		<!-- ÎÇ¥Í∞Ä ÌèâÍ∞ÄÌïú ÌèâÍ∞Ä Î¶¨Ïä§Ìä∏ (Ï†ÑÏ≤¥ Ï°∞Ìöå)
	 <select id="selectMyEvaluList" resultMap="formEmpMyList">
 			SELECT DISTINCT f.EVALU_NAME
		 					, f.EVALU_FORM_NO
					        , f.EVALU_START
					        , f.EVALU_END
					        , t.TEAM_NAME
					        , f.USAGE_STATUS
					        , f.EVALU_START
					        , f.EVALU_END 
					FROM EMPLOYEE u
					JOIN EVALUATEE_GROUP eg
					ON eg.USER_NO = u.USER_NO
					JOIN EVALU_FORM f
					ON eg.EVALU_FORM_NO = f.EVALU_FORM_NO
					JOIN TEAM t
					ON t.TEAM_NO = u.TEAM_NO
					WHERE f.EVALU_FORM_NO IN ( SELECT EVALU_FORM_NO
					                            FROM EVALU_GROUP
					                            WHERE USER_NO = #{userNo} )
					ORDER BY f.EVALU_FORM_NO DESC
	</select> -->
	
		<resultMap id="formEmpMyList" type="EvaluVO">
			  <id property="evaluFormNo" column="evalu_form_no" />
			  <result property="usageStatus" column="usage_status" />
			  <result property="evaluName" column="evalu_name" />
			  <result property="evaluStart" column="evalu_start" />
			  <result property="evaluEnd" column="evalu_end" />
              <result property="teamName" column="team_name" />
		</resultMap>
	<!-- ÌèâÍ∞Ä Ìèº Îì±Î°ù Ïãú ÌïÑÏöîÌïú Ìï≠Î™©Í≥º ÎÇ¥Ïö© ÏÑ†ÌÉùÌïòÍ∏∞ ÏúÑÌïú Ï°∞Ìöå ÏøºÎ¶¨Î¨∏ -->
	<select id="selectContentList" resultType="EvaluVO">
			SELECT EVALU_ITEM_NO
		        ,  EVALU_COMPET
		        ,  EVALU_CONTENT
			FROM EVALU_ITEM   
	</select>
	<!-- ÌèâÍ∞ÄÏûê Í∏∞Î∞ò ÌèâÍ∞ÄÏûê ÏßÅÍ∏â, Ïù¥Î¶Ñ, ÌåÄÎ™Ö, Î∂ÄÏÑúÎ™Ö, Ìèº Î≤àÌò∏ ÏøºÎ¶¨Î¨∏ -->
	<select id="selectEvaluInfoById" resultType="EvaluVO">
		SELECT
			d.DEPARTMENT_ID 
	        , u.USER_POSITION 
	        , u.USER_NAME  
	        , t.TEAM_NAME 
	        , d.DEPARTMENT_NAME 
	        , f.EVALU_FORM_NO
			, t.TEAM_NO
		FROM EMPLOYEE u 
		JOIN TEAM t ON u.TEAM_NO = t.TEAM_NO 
		JOIN DEPARTMENT d ON d.DEPARTMENT_ID = t.DEPARTMENT_ID 
		JOIN EVALU_GROUP g ON g.USER_NO = u.USER_NO  
		JOIN EVALU_FORM f ON g.EVALU_FORM_NO = f.EVALU_FORM_NO 
		WHERE f.EVALU_FORM_NO = #{evaluFormNo}
	</select>
	
	<!-- ÌîºÌèâÍ∞ÄÏûê Í∏∞Î∞ò ÌèâÍ∞ÄÏûê ÏßÅÍ∏â, Ïù¥Î¶Ñ, ÌåÄÎ™Ö, Î∂ÄÏÑúÎ™Ö, Ìèº Î≤àÌò∏ ÏøºÎ¶¨Î¨∏-->
	<select id="selectEvaluateeInfoById" resultType="EvaluVO">
		SELECT 
			d.DEPARTMENT_ID 
	        , u.USER_POSITION 
	        , f.EVALU_FORM_NO 
	        , u.USER_NAME
	        , t.TEAM_NAME 
	        , d.DEPARTMENT_NAME
	        , t.TEAM_NO
		FROM EMPLOYEE u 
		JOIN TEAM t ON u.TEAM_NO = t.TEAM_NO 
		JOIN DEPARTMENT d ON d.DEPARTMENT_ID = t.DEPARTMENT_ID 
		JOIN EVALUATEE_GROUP evg ON evg.USER_NO = u.USER_NO 
		JOIN EVALU_FORM f ON evg.EVALU_FORM_NO = f.EVALU_FORM_NO 
		WHERE f.EVALU_FORM_NO = #{evaluFormNo}
	</select>

	<!-- Î∂ÄÏÑúÎ™ÖÍ≥º ÌåÄÎ™Ö Ï°∞Ìöå ÏøºÎ¶¨Î¨∏ -->
	<select id="selectTeamList" resultType="EmpVO">
		SELECT t.team_no
		        , t.team_name
		        , d.department_name
		        , t.department_id
		FROM team t 
		JOIN department d 
		ON t.department_id = d.department_id
	</select>
	
	<!-- ÏÉà ÌèâÍ∞Ä Îì±Î°ù : form Î∂ÄÎ∂Ñ -->
	<insert id="insertEvaluForm" parameterType="EvaluVO">
		<selectKey keyProperty="evaluFormNo"
			   resultType="Integer"
			   order="BEFORE">
		 	SELECT EVALU_FORM_NO_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO EVALU_FORM
					(EVALU_FORM_NO
		            , EVALU_NAME
		            , INSERT_DATE
		            , EVALU_START
		            , EVALU_END
		            , USAGE_STATUS)
		VALUES 	(#{evaluFormNo}
		            , #{evaluName}
		            , SYSDATE
		            , #{evaluStart}
		            , #{evaluEnd}
		            , 'ÏßÑÌñâ Ï§ë')
	</insert>
	<!-- ÏÉà ÌèâÍ∞Ä Îì±Î°ù : format Î∂ÄÎ∂Ñ -->
	<insert id="insertEvaluFormat" parameterType="EvaluVO">	
      	INSERT INTO EVALU_FORMAT
			(EVALU_NO
			, ORDER_NO
			, EVALU_ITEM_NO
			, EVALU_FORM_NO)
			
		VALUES ( EVALU_NO_SEQ.NEXTVAL
			, #{orderNo}
			, #{evaluItemNo}
			, #{evaluFormNo}
			)
	</insert>
	<!-- ÏÉà ÌèâÍ∞Ä Îì±Î°ù : ÌèâÍ∞ÄÏûê Í∑∏Î£π ÏïÑÏù¥Îîî => Ï°∞ÌöåÎäî ÏÇ¨Ïõê Î≤àÌò∏ÏôÄ ÌèâÍ∞Ä Ìèº Î≤àÌò∏Î°ú -->
	<insert id="insertEvaluGroup" parameterType="EvaluVO">
			INSERT INTO EVALU_GROUP
			(
			    EVALU_GROUP_ID
			    , EVALU_FORM_NO
			    , USER_NO    
			    , USAGE_STATUS            
			)
			SELECT 
			    EVALU_G_ID_SEQ.NEXTVAL
			    , #{evaluFormNo}
			    , u.user_no
			    , 'ÏßÑÌñâ Ï§ë'
			FROM EMPLOYEE u 
			JOIN TEAM t ON u.team_no = t.team_no
			WHERE t.team_no = #{evaluGroupId}
	</insert>
	<!-- ÏÉà ÌèâÍ∞Ä Îì±Î°ù : ÌîºÌèâÍ∞ÄÏûê Í∑∏Î£π ÏïÑÏù¥Îîî -->
	<insert id="insertEvaluateeGroup" parameterType="EvaluVO">
		INSERT INTO EVALUATEE_GROUP
		(
		    EVALUATEE_GROUP_ID
		    , EVALU_FORM_NO
		    , USER_NO                
		)
		SELECT 
		    EVALUATEE_G_ID_SEQ.NEXTVAL
		    , #{evaluFormNo}
		    , u.user_no
		FROM EMPLOYEE u 
		JOIN TEAM t ON u.team_no = t.team_no
		WHERE t.team_no = #{evaluateeGroupId}
	</insert>

	<!-- ÌèâÍ∞Ä ÏßÑÌñâ : ÌèâÍ∞Ä Í≤∞Í≥º ÌÖåÏù¥Î∏îÏóê insert-->
	<insert id="insertEvaluScore" parameterType="EvaluVO">
		INSERT INTO EVALU_RESULT
	            ( EVALU_RESULT_ID
	             , EVALU_SCORE
	             , EVALU_DATE 
	             , EVALU_GROUP_ID 
	             , EVALUATEE_GROUP_ID
	             , EVALU_NO
	             , EVALU_FORM_NO
	             , ORDER_NO
	             , USER_NO    )
		VALUES ( EVALU_RESULT_ID_SEQ.NEXTVAL 
		       , #{evaluScore}
		       , SYSDATE
		       , #{evaluGroupId}
		       , #{evaluateeGroupId}
		       , #{evaluNo}
		       , #{evaluFormNo}
		       , #{orderNo}
		       , #{userNo} )
	</insert>
	
	<!-- ÌèâÍ∞Ä Ï†úÏ∂ú ÌõÑ Í∞úÏù∏ ÌèâÍ∞Ä ÏÉÅÌÉú 'Ï†úÏ∂ú ÏôÑÎ£å' Î°ú ÏàòÏ†ïÌïòÎäî ÏøºÎ¶¨Î¨∏ -->
	<update id="updateEvaluStatus" parameterType="EvaluVO">
		UPDATE EVALU_GROUP 
		SET USAGE_STATUS = 'Ï†úÏ∂ú ÏôÑÎ£å'
		WHERE EVALU_FORM_NO = #{evaluFormNo}
		  AND USER_NO = #{userNo}
	</update>
	<!-- EVALU_GROUPÏóêÏÑú Í∞úÏù∏ ÌèâÍ∞Ä ÏÉÅÌÉú Ï°∞Ìöå -->
	<select id="selectMyEvaluStatus" resultType="String" parameterType="EvaluVO">
	    SELECT USAGE_STATUS
	    FROM EVALU_GROUP
	    WHERE EVALU_FORM_NO = #{evaluFormNo}
	      AND USER_NO = #{userNo}
	</select>
	<!-- ÌèâÍ∞Ä ÏÉÅÌÉú Ï°∞Ìöå ÏøºÎ¶¨ -->
	<select id="getEvaluStatus" resultType="String" parameterType="int">
	    SELECT USAGE_STATUS
	    FROM EVALU_FORM
	    WHERE EVALU_FORM_NO = #{formNo}
	</select>
	
	<!-- ÌîºÌèâÍ∞ÄÏûê : loginUserÏù∏ ÌèâÍ∞Ä(ÌèâÍ∑†) -->
	<select id="selectMyReceivedAvgScore" resultType="EvaluVO">
			SELECT
			    i.EVALU_COMPET,
			    i.EVALU_CONTENT,
			    AVG(r.EVALU_SCORE) AS evaluScore,
			    fm.ORDER_NO
			FROM EVALU_RESULT r
			JOIN EVALUATEE_GROUP g
			    ON r.EVALUATEE_GROUP_ID = g.EVALUATEE_GROUP_ID
			JOIN EVALU_FORMAT fm
			    ON r.EVALU_NO = fm.EVALU_NO
			JOIN EVALU_ITEM i
			    ON fm.EVALU_ITEM_NO = i.EVALU_ITEM_NO
			WHERE g.USER_NO = #{userNo}               
			  AND r.EVALU_FORM_NO = #{evaluFormNo}    
			GROUP BY i.EVALU_COMPET, i.EVALU_CONTENT, fm.ORDER_NO
			ORDER BY fm.ORDER_NO
</select>
<!-- ÎÇ¥Í∞Ä ÌîºÌèâÍ∞ÄÏûêÎ°ú Îì±Î°ùÎêú ÌèâÍ∞Ä Î¶¨Ïä§Ìä∏ -->
	<select id="selectMyEvaluResultList" resultMap="myEvaluResultList">
		SELECT 
		    f.EVALU_NAME,
		    f.EVALU_FORM_NO,
		    f.EVALU_START,
		    f.EVALU_END,
		    t.TEAM_NAME,
		    f.USAGE_STATUS
		FROM EVALUATEE_GROUP eg
		JOIN EVALU_FORM f ON eg.EVALU_FORM_NO = f.EVALU_FORM_NO
		JOIN EMPLOYEE u ON eg.USER_NO = u.USER_NO
		JOIN TEAM t ON t.TEAM_NO = u.TEAM_NO
		
		WHERE eg.USER_NO = #{userNo}
		ORDER BY f.EVALU_FORM_NO DESC
	</select>
	
		<resultMap id="myEvaluResultList" type="EvaluVO">
		<id property="evaluFormNo" column="evalu_form_no" />
		  <result property="usageStatus" column="usage_status" />
			<result property="evaluName" column="evalu_name" />
				<result property="evaluStart" column="evalu_start" />
				<result property="evaluEnd" column="evalu_end" />
				<collection property="teamList" ofType="teamVO">
					<result property="teamName" column="team_name" />
				</collection>
	</resultMap>
	
	<!-- ÎÇ¥Í∞Ä ÌèâÍ∞Ä Î∞õÏùÄ ÌèâÍ∞Ä Îã®Í±¥ Ï°∞Ìöå -->
	<select id="selectMyEvaluScoreResultById" resultType="EvaluVO">
		SELECT 
		    u.USER_NO,
		    u.USER_NAME,
		    i.EVALU_COMPET,
		    i.EVALU_CONTENT,
		    d.DEPARTMENT_NAME,
		    t.TEAM_NAME,
		    f.EVALU_NAME,
		    ROUND(AVG(r.EVALU_SCORE), 1) AS avgScore,  -- ÎÇ¥ ÌèâÍ∑† Ï†êÏàò
		    (
		        SELECT ROUND(AVG(r2.EVALU_SCORE), 1) 
		        FROM EVALU_RESULT r2
		        JOIN EVALUATEE_GROUP g2 ON r2.EVALUATEE_GROUP_ID = g2.EVALUATEE_GROUP_ID
		        WHERE g2.EVALU_FORM_NO = #{evaluFormNo} 
		          AND g2.USER_NO != #{userNo}
		          AND r2.EVALU_NO = r.EVALU_NO
		    ) AS otherAvgScore,  -- Îã§Î•∏ ÏÇ¨ÎûåÎì§Ïùò ÌèâÍ∑† Ï†êÏàò (Ìï≠Î™©Î≥Ñ)
		    fm.ORDER_NO
		FROM EVALU_FORM f
		JOIN EVALUATEE_GROUP g ON f.EVALU_FORM_NO = g.EVALU_FORM_NO
		JOIN EMPLOYEE u ON g.USER_NO = u.USER_NO
		JOIN EVALU_FORMAT fm ON fm.EVALU_FORM_NO = f.EVALU_FORM_NO
		JOIN EVALU_ITEM i ON i.EVALU_ITEM_NO = fm.EVALU_ITEM_NO
		JOIN EVALU_RESULT r ON r.EVALU_NO = fm.EVALU_NO 
		                     AND r.EVALUATEE_GROUP_ID = g.EVALUATEE_GROUP_ID
		JOIN TEAM t ON t.team_no = u.team_no
		JOIN DEPARTMENT d ON d.department_id = t.department_id
		WHERE f.EVALU_FORM_NO = #{evaluFormNo}
		  AND u.USER_NO = #{userNo}
		GROUP BY 
		    u.USER_NO,
		    u.USER_NAME,
		    i.EVALU_COMPET,
		    i.EVALU_CONTENT,
		    fm.ORDER_NO,
		    d.DEPARTMENT_NAME,
		    f.EVALU_NAME,
		    t.TEAM_NAME,
		    r.EVALU_NO  <!-- Ïù¥ Î∂ÄÎ∂Ñ Î∞òÎìúÏãú Ìè¨Ìï® -->
		ORDER BY fm.ORDER_NO
	</select>

	
	<!-- Î∂ÄÏÑú Ï†ÑÏ≤¥ -->
	<select id="selectDepartmentList" resultType="DepartmentVO">
		SELECT d.DEPARTMENT_ID 
	        , u.USER_NAME
	        , d.DEPARTMENT_NAME
	        , t.TEAM_NAME
		FROM DEPARTMENT d 
		JOIN TEAM t
		ON d.DEPARTMENT_ID = t.department_id
		JOIN EMPLOYEE u
		ON u.USER_NO = d.department_head
		ORDER BY DEPARTMENT_ID 
	</select>
	<!-- Î∂ÄÏÑú Îã®Í±¥ Ï°∞Ìöå -->
	<select id="selectDepartmentById" resultType="DepartmentVO">
		SELECT 
	        d.DEPARTMENT_ID
	        , d.DEPARTMENT_NAME
	        , u.USER_NAME
	        , u.USER_MAIL
	        , u.USER_PHONE
	        , d.DEPT_WORK
	        , d.DEPT_LOCATION
	        , d.BUDGET
	        , t.TEAM_NAME
        FROM DEPARTMENT d 
		JOIN TEAM t
		ON d.DEPARTMENT_ID = t.department_id
		JOIN EMPLOYEE u
		ON u.USER_NO = d.department_head
		WHERE d.DEPARTMENT_ID = #{departmentId}
		ORDER BY d.DEPARTMENT_ID
	</select>
	<!-- Î∂ÄÏÑú Îì±Î°ù -->
	<insert id="insertNewDepartment" parameterType="DepartmentVO">
	  <selectKey keyProperty="departmentId" resultType="String" order="BEFORE">
	    SELECT 'D' || LPAD(DEPT_SEQ.NEXTVAL, 3, '0') FROM DUAL
	  </selectKey>
	
	  INSERT INTO DEPARTMENT (
	    DEPARTMENT_ID,
	    DEPARTMENT_NAME,
	    DEPARTMENT_HEAD,
	    DEPT_WORK,
	    DEPT_LOCATION,
	    BUDGET
	  )
	  VALUES (
	    #{departmentId},
	    #{departmentName},
	    #{departmentHead},
	    #{deptWork},
	    #{deptLocation},
	    #{budget}
	  )
	</insert>
	<!-- ÌåÄ Îì±Î°ù -->
	<insert id="insertNewTeam" parameterType="TeamVO">
  <selectKey keyProperty="teamNo" resultType="String" order="BEFORE">
    SELECT 'T' || LPAD(TEAM_SEQ.NEXTVAL, 3, '0') FROM DUAL
  </selectKey>
	
	  INSERT INTO TEAM (
	    TEAM_NO,
	    TEAM_NAME,
	    DEPARTMENT_ID
	  ) VALUES (
	    #{teamNo},
	    #{teamName},
	    #{departmentId}
	  )
</insert>

<!-- ÌèâÍ∞Ä Ï¢ÖÎ£åÏùºÏù¥ ÏßÄÎÇú Ìèº : ÌèâÍ∞Ä ÏôÑÎ£åÎ°ú -->
<update id="updateStatusByEvaluEndDate">
    UPDATE EVALU_FORM
    SET USAGE_STATUS = 'ÌèâÍ∞Ä ÏôÑÎ£å'
    WHERE EVALU_END <![CDATA[<]]> SYSDATE
      AND USAGE_STATUS != 'ÌèâÍ∞Ä ÏôÑÎ£å'
</update>
	<!-- Î∂ÄÏÑú ÏàòÏ†ï -->
</mapper>